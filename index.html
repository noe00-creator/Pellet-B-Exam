<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PELLETB Practice Exam â€” 5 Sections â€¢ 3 Hours (v4)</title>
  <style>
    :root{--bg:#0b1020;--card:#121936;--ink:#f6f8ff;--muted:#a9b3d0;--accent:#7aa2ff;--good:#1ad598;--bad:#ff5a7a}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0a0f1e,#0f1630);}
    .wrap{max-width:1100px;margin:0 auto;padding:24px;color:var(--ink)}
    h1{font-weight:800;letter-spacing:.3px;margin:4px 0 12px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px 18px;box-shadow:0 12px 20px rgba(0,0,0,.25)}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;gap:8px;align-items:center;background:#0d1330;border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.primary{background:var(--accent);color:#08112b}
    button.ghost{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.15)}
    button.danger{background:var(--bad);color:#08112b}
    button.good{background:var(--good);color:#04141a}
    button:disabled{opacity:.5;cursor:not-allowed}
    .section-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{background:#0e1440;border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:12px;color:var(--muted);cursor:pointer;font-weight:700}
    .tab.active{background:var(--accent);color:#070e28}
    .timer{font-variant-numeric:tabular-nums;font-weight:800}
    .q{margin:12px 0 18px}
    .q h3{margin:0 0 10px;font-size:18px}
    .opt{display:flex;gap:10px;align-items:flex-start;border:1px solid rgba(255,255,255,.12);padding:10px;border-radius:12px;margin:8px 0;background:#0c1234;cursor:pointer}
    .opt input{margin-top:2px}
    .feedback{margin-top:8px;font-weight:700}
    .feedback.good{color:var(--good)}
    .feedback.bad{color:var(--bad)}
    .controls{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px}
    .progress{height:8px;background:#0a0f28;border-radius:8px;overflow:hidden}
    .bar{height:8px;background:var(--accent);width:0}
    .muted{color:var(--muted)}
    input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1233;color:var(--ink)}
    .small{font-size:12px;color:var(--muted)}
    .banner{display:flex;gap:12px;align-items:center;justify-content:space-between;background:#09102c;border:1px dashed rgba(255,255,255,.18);padding:10px 12px;border-radius:12px;margin:10px 0}
    .summary h2{margin:4px 0 10px}
    .summary .stat{display:inline-block;background:#0e1440;border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:12px;margin-right:8px}
    .summary .miss{border:1px solid rgba(255,255,255,.15);padding:10px;border-radius:12px;margin:10px 0;background:#0b1233}
    .big-actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h1>PELLETB Practice Exam â€” 5 Sections â€¢ 3 Hours (v4)</h1>
          <div class="row">
            <span class="badge"><strong>Total Time:</strong> <span class="timer" id="totalTimer">03:00:00</span></span>
            <span class="badge"><strong>Section Time:</strong> <span class="timer" id="sectionTimer">36:00</span></span>
            <span class="badge" id="scoreBadge">Score: 0</span>
          </div>
        </div>
        <div class="big-actions">
          <button class="good" id="saveBtn">ðŸ’¾ Save & Pause</button>
          <button class="ghost" id="resumeBtn" style="display:none">â–¶ Resume</button>
          <button class="danger" id="finishBtn">âœ” Finish & Review</button>
        </div>
      </div>

      <div class="banner" id="resumeBanner" style="display:none">
        <div>Saved progress detected. Resume where you left off with your remaining time intact.</div>
        <div class="row">
          <button class="good" id="resumeNow">Resume now</button>
          <button class="ghost" id="startOver">Start over</button>
        </div>
      </div>

      <div class="section-tabs" id="tabs"></div>
      <div id="screen"></div>
      <div class="controls" id="navControls">
        <div style="flex:1">
          <div class="progress"><div id="progressBar" class="bar"></div></div>
          <div class="small" id="progressText">Question 0 of 0</div>
        </div>
        <div class="row">
          <button class="ghost" id="prevBtn">â—€ Prev</button>
          <button class="primary" id="nextBtn">Next â–¶</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Immediate feedback appears after you answer. Use <strong>Save & Pause</strong> to preserve answers and the exact remaining time.</div>
    </div>
  </div>

<script>
// ========= STORAGE & UTILS =========
const STORAGE_KEY = 'pelletb.practice.v4.five.sections'; // new key to ignore old timers
function $(id){return document.getElementById(id)}
function fmt(ms){
  const s=Math.max(0,Math.floor(ms/1000));
  const hh=String(Math.floor(s/3600)).padStart(2,'0');
  const mm=String(Math.floor((s%3600)/60)).padStart(2,'0');
  const ss=String(s%60).padStart(2,'0');
  return hh+':'+mm+':'+ss;
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)] }

// ========= QUESTION GENERATORS =========
// WRITING (50): grammar/clarity/punctuation
function buildWriting(){
  const items=[];
  const sv = [
    ['Neither the witnesses nor the suspect are credible.','Neither the witnesses nor the suspect is credible.','Neither the witness nor the suspects is credible.','Neither the witnesses nor the suspects is credible.',1],
    ['Each of the students have a pass.','Each of the students has a pass.','Each of the student have a pass.','Each of the student has a pass.',1],
    ['Either the officers or the sergeant are responding.','Either the officers or the sergeant is responding.','Either the officers or the sergeant were responding.','Either the officers nor the sergeant is responding.',1],
    ['A number of calls is pending.','A number of calls are pending.','The number of calls are pending.','The number of calls were pending.',1]
  ];
  const comma = [
    ['We arrived and, cleared the hallway.','We arrived and cleared the hallway.','We arrived, and cleared the hallway.','We, arrived and cleared the hallway.',1],
    ['Mr. Lopez who teaches math called 911.','Mr. Lopez, who teaches math called 911.','Mr. Lopez, who teaches math, called 911.','Mr. Lopez who teaches math, called 911.',2],
    ['The door was forced open however the frame was fine.','The door was forced open; however, the frame was fine.','The door was forced open, however, the frame was fine.','The door was forced open however, the frame was fine.',1],
    ['We canvassed the area, interviewed witnesses, and wrote the report.','We canvassed the area, interviewed witnesses and, wrote the report.','We canvassed, the area, interviewed witnesses, and wrote the report.','We canvassed the area interviewed witnesses, and wrote the report.',0]
  ];
  const clarity = [
    ['Having finished the interview, the report was written by Officer Diaz.','After Officer Diaz finished the interview, she wrote the report.','The report was written after finishing the interview by Officer Diaz.','After finishing, the report was written.',1],
    ['The victim reported seeing a man with a hat and a backpack running.','The victim reported that a man wearing a hat and backpack was running.','The victim reported seeing a man running with a hat and backpack (unclear).','Running, the victim reported a man with a hat and backpack.',1],
    ['There was a very loud and extremely noisy disturbance.','Witnesses reported a loud disturbance.','It was like super loud and stuff.','The disturbance was allegedly loudish.',1]
  ];
  const tone = [
    ['The perp totally freaked out.','The subject became visibly agitated.','The dude got mad.','The suspect was like, angry.',1],
    ['The officer read the miranda rights.','The officer read the Miranda rights.','The Officer read the Miranda rights.','The officer read the miranda Rights.',1]
  ];
  const hyphen = [
    ['blue colored backpack','blue-colored backpack','blue colored-backpack','blue colored back-pack',1],
    ['a well known student','a well-known student','a well known-student','a well- known student',1]
  ];
  const splice = [
    ['We arrived, we cleared the room.','We arrived; we cleared the room.','We arrived however we cleared the room.','We arrived, and cleared the room.',1]
  ];
  const bank = [sv,comma,clarity,tone,hyphen,splice];
  while(items.length<50){
    const group = choice(bank);
    const q = choice(group);
    const opts = q.slice(0,4); const answer=q[4];
    items.push({type:'mc', prompt:'Choose the best sentence.', choices:opts, answer, explain:'Focus on grammar, punctuation, and clarity.'});
  }
  return items;
}

// SPELLING MC (50): heavy LE/legal/report terms
function buildSpelling(){
  const words = [
    'subpoena','paraphernalia','surveillance','possession','occurred','warrant','pursue','forfeiture','acquittal','liaison','seized','misdemeanor','separate','license','Miranda','resistance','violation','juvenile','judgment','warehouse','perpetrator','trespassing','contraband','burglary','robbery','trespasser','tactical','narcotics','homicide','embezzlement','trespass','trespassed','trespasses','investigate','investigation','suspect','witness','victim','probation','parole','arraignment','custody','evidence','perimeter','dispatch','survivor','accomplice','contradictory','coercion','negligence'
  ];
  function misspell(word){
    const variants=new Set();
    // generate variants without using '$1'
    variants.add(word.replace(/ie/g,'ei'));
    variants.add(word.replace(/ei/g,'ie'));
    variants.add(word.replace(/([a-z])\\1/, function(_,p){ return p; })); // drop a double letter
    variants.add(word.replace(/e$/,'')); // drop trailing e
    variants.add(word.replace(/a/g,'e'));
    variants.add(word.replace(/c/g,'s'));
    variants.add(word.replace(/ph/g,'f'));
    return Array.from(variants).filter(v=>v.toLowerCase()!==word.toLowerCase() && v.length>2).slice(0,6);
  }
  const items=[];
  words.slice(0,50).forEach(function(w){
    let ds = misspell(w);
    while(ds.length<3){ ds.push(w + 'e'); }
    const opts = shuffle([w, ds[0], ds[1], ds[2]]);
    items.push({type:'mc', prompt:'Choose the correct spelling.', choices:opts, answer:opts.indexOf(w), explain:'Correct: '+w});
  });
  return items;
}

// READING (50): templated passages
function buildReading(){
  const streets=['Pine St','Maple Ave','Cedar Blvd','Oak St','Elm Rd','Grant St'];
  const colors=['blue','white','black','silver','red'];
  const vehicle=['sedan','SUV','hatchback','pickup'];
  const items=[];
  for(let i=0;i<20;i++){
    const st=choice(streets), col=choice(colors), veh=choice(vehicle);
    const p='Officers responded at 2215 hrs to 8'+i+i+' '+st+'. A window was broken; a wallet lay on the sidewalk. Neighbors saw a '+col+' '+veh+' leave eastbound moments earlier.';
    items.push({type:'mc', prompt:'Passage: '+p+' What detail most suggests forced entry?', choices:['Time of call','Broken window','Wallet on sidewalk','The '+col+' '+veh], answer:1, explain:'A broken window indicates a breach.'});
  }
  const policyQs=[
    ['New policy requires logging control holds within 24 hours; supervisors review weekly. Primary purpose of weekly review?', ['Discipline','App maintenance','Oversight & training needs','Eliminate control holds'],2],
    ['Secondary searches required before transport; several cases lack notation. Primary concern?', ['Officer safety risk','Report too long','Old transport log','Property overload'],0],
    ['Park closes 2200; cooperative runner at 2215; education-first policy. Best immediate action?', ['Cite immediately','Detain for trespass','Warn and explain posted hours','Arrest for resisting'],2]
  ];
  while(items.length<50){
    const picked = choice(policyQs);
    items.push({type:'mc', prompt:'Passage: '+picked[0], choices:picked[1], answer:picked[2]});
  }
  return items;
}

// REASONING (50): logic/syllogisms/order
function buildReasoning(){
  const items=[];
  for(let i=0;i<15;i++){
    items.push({type:'mc', prompt:'No vehicles are allowed in Lane 2. All delivery trucks are vehicles. Which is true?', choices:['Some delivery trucks may use Lane 2.','No delivery trucks may use Lane 2.','Only emergency vehicles may use Lane 2.','Lane 2 is closed.'], answer:1});
  }
  for(let i=0;i<10;i++){
    items.push({type:'mc', prompt:'Interviews: A before B; C last. Which order is valid?', choices:['A, C, B','B, A, C','A, B, C','C, A, B'], answer:2});
  }
  for(let i=0;i<10;i++){
    items.push({type:'mc', prompt:'Every third car is inspected. The 9th is inspected. Which is also inspected?', choices:['12th','13th','14th','11th'], answer:0});
  }
  for(let i=0;i<10;i++){
    items.push({type:'mc', prompt:'Keys are in locker, desk, or patrol car. Not in locker. If in patrol car, Kim would have found them (she did not). Where are they?', choices:['Locker','Desk','Patrol car','Unknown'], answer:1});
  }
  for(let i=0;i<5;i++){
    items.push({type:'mc', prompt:'Exactly one is true: (1) suspect wore a hat; (2) suspect wore glasses; (3) suspect wore neither. Which is true?', choices:['(1)','(2)','(3)','None'], answer:0});
  }
  return items;
}

// VOCAB (50): definitions & usage
function buildVocab(){
  const bank=[
    ['probable cause','Facts that would lead a reasonable person to believe a crime was committed',['A mere hunch','Facts that would lead a reasonable person to believe a crime was committed','Proof beyond a reasonable doubt','Any anonymous tip']],
    ['consensual encounter','A voluntary interaction where the person is free to leave',['A detention without cause','A voluntary interaction where the person is free to leave','A formal arrest','A custodial interrogation']],
    ['contraband','Illegal or prohibited items',['Any property','Illegal or prohibited items','Lost and found property','Evidence only']],
    ['exigent circumstances','Emergency conditions requiring immediate action',['Routine circumstances','Emergency conditions requiring immediate action','Court orders','Witness interviews']],
    ['chain of custody','Documentation of evidence from collection to court',['Order of suspects arrested','Documentation of evidence from collection to court','List of witnesses','Booking order']],
    ['disposition','Final handling/outcome of a case or call',['Officerâ€™s mood','Final handling/outcome of a case or call','The crime code','The court calendar']],
    ['restitution','Payment to victim for loss/damage',['Community service','Payment to victim for loss/damage','Court fine','Donation']],
    ['perimeter','Boundary established to control access',['Inside of a room','Boundary established to control access','Only the back door','Tape length']],
    ['articulate (verb)','Express clearly with supporting facts',['Draw a diagram','Express clearly with supporting facts','Use advanced vocabulary','Speak loudly']],
    ['detain vs arrest','Detain=brief reasonable stop; Arrest=taking into custody',['Same thing','Detain=brief reasonable stop; Arrest=taking into custody','Arrest is brief; detain is custodial','No standards apply']]
  ];
  const usage=[
    ['Choose the best report phrasing.',['The suspect had a gun, which was black in color.','The suspect possessed a black handgun.','The suspect had a weapon thing that was black.','The suspect had a gun that looked scary.'],1],
    ['Best objective wording.',['I felt the student was lying.','The student avoided eye contact and gave inconsistent answers.','The student seemed shady.','The student obviously lied.'],1],
    ['â€œPretext stopâ€ meansâ€¦',['Stop for a minor violation while investigating another suspicion','Traffic break for construction','Administrative checkpoint','Felony stop'],0]
  ];
  const items=[];
  while(items.length<50){
    if(items.length<30){
      const row = choice(bank); const term=row[0], def=row[1], opts=row[2].slice();
      items.push({type:'mc', prompt:'Definition: â€œ'+term+'â€', choices:opts, answer:opts.indexOf(def)});
    } else {
      const u = choice(usage);
      items.push({type:'mc', prompt:u[0], choices:u[1], answer:u[2]});
    }
  }
  return items;
}

// ========= BUILD SECTIONS =========
const WRITING = { id:'writing', label:'Writing (Clarity & Grammar)', minutes:36, questions: buildWriting() };
const SPELLING = { id:'spelling', label:'Spelling (Common LE/Legal Words)', minutes:36, questions: buildSpelling() };
const READING  = { id:'reading', label:'Reading Comprehension', minutes:36, questions: buildReading() };
const REASONING= { id:'reasoning', label:'Reasoning Ability', minutes:36, questions: buildReasoning() };
const VOCAB    = { id:'vocab', label:'Vocabulary & Report Usage (LE Terms)', minutes:36, questions: buildVocab() };
let SECTIONS = [WRITING, SPELLING, READING, REASONING, VOCAB];

// ========= STATE =========
const state = {sectionIndex:0, qIndex:0, answers:{}, correct:0, total:0, sectionEnds:[], totalEnds:0, running:true};

// ========= FIXED-TIME INITIALIZATION (36 min each, total 180) =========
const AUTO_TIME = false;
function prepareSectionsFromScratch(){ SECTIONS = SECTIONS.map(sec=>({ ...sec, questions: shuffle(sec.questions.slice()) })); }
function computeTimers(restored){
  const now=Date.now(); let acc=0; state.sectionEnds=[];
  for(let i=0;i<SECTIONS.length;i++){
    let dur = SECTIONS[i].minutes*60*1000;
    if(restored && i===state.sectionIndex && restored.remainingCurrentMs!=null){ dur = restored.remainingCurrentMs; }
    acc += dur; state.sectionEnds.push(now+acc);
  }
  state.totalEnds = state.sectionEnds[state.sectionEnds.length-1];
}
function saveProgress(pause=true){
  const now=Date.now(); const secEnd = state.sectionEnds[state.sectionIndex]; const remainingCurrentMs = Math.max(0, secEnd - now);
  const payload = {version:4, paused:!!pause, remainingCurrentMs, sectionIndex: state.sectionIndex, qIndex: state.qIndex, answers: state.answers, correct: state.correct, sections: SECTIONS};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  if(pause){ state.running=false; $('resumeBtn').style.display='inline-block'; alert('Saved & paused. You can close the tab and resume later.'); }
}
function tryLoadSaved(){ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return null; try{return JSON.parse(raw)}catch{ return null } }
function applySaved(saved, autoResume=true){
  if(!saved) return false;
  SECTIONS = saved.sections||SECTIONS;
  state.answers=saved.answers||{};
  state.correct=saved.correct||0;
  state.sectionIndex=saved.sectionIndex||0;
  state.qIndex=saved.qIndex||0;
  computeTimers({remainingCurrentMs: saved.remainingCurrentMs});
  state.total = SECTIONS.reduce(function(a,s){return a+s.questions.length},0);
  if(autoResume){
    state.running=true; $('resumeBanner').style.display='none'; $('resumeBtn').style.display='none';
  } else {
    state.running=false; $('resumeBanner').style.display='flex'; $('resumeBtn').style.display='inline-block';
  }
  return true;
}
function resetAll(){ localStorage.removeItem(STORAGE_KEY); location.reload(); }

function init(){
  const saved = tryLoadSaved();
  if(saved){ applySaved(saved,false); }
  else { prepareSectionsFromScratch(); computeTimers(null); state.total = SECTIONS.reduce(function(a,s){return a+s.questions.length},0); }
  buildTabs(); render(); tick();
}

// ========= UI RENDER =========
function buildTabs(){
  const tabs=$('tabs'); tabs.innerHTML='';
  SECTIONS.forEach(function(sec,i){
    const b=document.createElement('button');
    b.className='tab'+(i===state.sectionIndex?' active':'');
    b.textContent=(i+1)+'. '+sec.label;
    b.onclick=function(){ state.sectionIndex=i; state.qIndex=0; renderTabs(); render(); };
    tabs.appendChild(b);
  });
}
function renderTabs(){ Array.prototype.forEach.call(document.querySelectorAll('.tab'), function(el,idx){ el.classList.toggle('active', idx===state.sectionIndex); }); }

function render(){
  const sec=SECTIONS[state.sectionIndex]; const q=sec.questions[state.qIndex]; const sKey=sec.id+':'+state.qIndex; const ans=state.answers[sKey];
  const answered = Object.keys(state.answers).length; const correctCnt = Object.values(state.answers).filter(function(a){return a.correct}).length;
  $('scoreBadge').textContent='Score: '+correctCnt;
  $('progressText').textContent='Question '+(state.qIndex+1)+' of '+sec.questions.length+' (Section '+(state.sectionIndex+1)+'/'+SECTIONS.length+') â€¢ Answered: '+answered+'/'+state.total;
  $('progressBar').style.width = ((state.qIndex+1)/sec.questions.length*100)+'%';

  const screen=$('screen'); screen.innerHTML='';
  const qWrap=document.createElement('div'); qWrap.className='q';
  const h=document.createElement('h3'); h.textContent=q.prompt; qWrap.appendChild(h);

  if(q.type==='mc'){
    q.choices.forEach(function(c,i){
      const row=document.createElement('label'); row.className='opt';
      const radio=document.createElement('input'); radio.type='radio'; radio.name='mc'; radio.value=i; radio.checked = ans && ans.choice===i;
      radio.onchange=function(){ gradeMC(i); };
      const span=document.createElement('div'); span.textContent=c;
      row.appendChild(radio); row.appendChild(span); qWrap.appendChild(row);
      if(ans){
        if(i===q.answer){ row.style.borderColor='rgba(26,213,152,.9)'; }
        if(ans.choice===i && i!==q.answer){ row.style.borderColor='rgba(255,90,122,.9)'; }
      }
    });
  }

  const exp=document.createElement('div'); exp.className='muted'; exp.style.marginTop='8px';
  if(ans && q.explain){ exp.innerHTML = '<strong>Why:</strong> '+q.explain; }
  qWrap.appendChild(exp);
  screen.appendChild(qWrap);

  $('prevBtn').disabled = state.qIndex===0;
  $('nextBtn').disabled = state.qIndex===sec.questions.length-1;
}

// ========= GRADING =========
function gradeMC(choiceIdx){
  const sec=SECTIONS[state.sectionIndex]; const q=sec.questions[state.qIndex]; const key=sec.id+':'+state.qIndex;
  const correct=(choiceIdx===q.answer);
  state.answers[key]={graded:true, choice:choiceIdx, correct};
  render();
}

// ========= NAV + TIMERS =========
$('prevBtn').onclick=function(){ if(state.qIndex>0){ state.qIndex--; render(); } };
$('nextBtn').onclick=function(){ const sec=SECTIONS[state.sectionIndex]; if(state.qIndex<sec.questions.length-1){ state.qIndex++; render(); } };
$('finishBtn').onclick=function(){ showSummary(); };
$('saveBtn').onclick=function(){ saveProgress(true); };
$('resumeBtn').onclick=function(){ resumeNow(); };
$('resumeNow').onclick=function(){ resumeNow(); };
$('startOver').onclick=function(){ resetAll(); };

function resumeNow(){ const saved=tryLoadSaved(); if(saved){ applySaved(saved,true); render(); tick(); }}

function tick(){
  if(!state.running) return;
  const now=Date.now();
  const totalLeft=state.totalEnds-now; $('totalTimer').textContent=fmt(totalLeft);
  const secEnd=state.sectionEnds[state.sectionIndex]; $('sectionTimer').textContent=fmt(secEnd-now);
  if(totalLeft<=0){ state.running=false; showSummary(true); return; }
  requestAnimationFrame(tick);
}

// ========= SUMMARY =========
function showSummary(timeUp){
  state.running=false;
  const screen=$('screen'); screen.innerHTML=''; $('navControls').style.display='none';
  const wrapper=document.createElement('div'); wrapper.className='summary';
  const totalQ = SECTIONS.reduce(function(a,s){return a+s.questions.length},0);
  const correct = Object.values(state.answers).filter(function(a){return a.correct}).length;
  const percent = Math.round((correct/totalQ)*100);
  const h2=document.createElement('h2'); h2.textContent = timeUp? 'Time! Results & Review':'Results & Review';
  wrapper.appendChild(h2);
  const stats=document.createElement('div');
  let html = '<span class="stat">Score: <strong>'+correct+'/'+totalQ+'</strong> ('+percent+'%)</span>';
  SECTIONS.forEach(function(sec,i){
    const keys = Object.keys(state.answers).filter(function(k){return k.indexOf(sec.id+':')===0});
    const c = keys.filter(function(k){return state.answers[k] && state.answers[k].correct}).length;
    html += ' <span class="stat">'+(i+1)+'. '+sec.label+': <strong>'+c+'/'+sec.questions.length+'</strong></span>';
  });
  stats.innerHTML = html; wrapper.appendChild(stats);

  const misses=[];
  SECTIONS.forEach(function(sec){
    sec.questions.forEach(function(q,idx){
      const k=sec.id+':'+idx; const a=state.answers[k];
      if(!a || !a.correct){ misses.push({sec:sec, q:q, idx:idx, a:a}); }
    });
  });
  if(misses.length){
    const t=document.createElement('h3'); t.textContent='Missed or Unanswered Questions'; wrapper.appendChild(t);
    misses.forEach(function(m){
      const div=document.createElement('div'); div.className='miss';
      const chosen = (m.a && m.a.choice!=null) ? m.q.choices[m.a.choice] : '(no answer)';
      const correctText = m.q.choices[m.q.answer];
      div.innerHTML = '<strong>Section:</strong> '+m.sec.label+'<br><strong>Question:</strong> '+m.q.prompt+'<br><strong>Your answer:</strong> '+chosen+'<br><strong>Correct:</strong> '+correctText+(m.q.explain? '<br><em>Why:</em> '+m.q.explain:'');
      wrapper.appendChild(div);
    });
  }

  const actions=document.createElement('div'); actions.className='row';
  const restart=document.createElement('button'); restart.className='ghost'; restart.textContent='Start a New Attempt'; restart.onclick=function(){ resetAll(); };
  const saveRep=document.createElement('button'); saveRep.className='primary'; saveRep.textContent='Save Results'; saveRep.onclick=function(){ saveProgress(true); };
  actions.appendChild(restart); actions.appendChild(saveRep);
  wrapper.appendChild(actions);
  screen.appendChild(wrapper);
}

// ========= BOOT =========
window.addEventListener('beforeunload', function(){ if(state.running){ saveProgress(true); } });
function buildTabsOnce(){ /* no-op, kept for future */ }
function computeTotalQuestions(){ state.total = SECTIONS.reduce(function(a,s){return a+s.questions.length},0); }
function startFresh(){ prepareSectionsFromScratch(); computeTimers(null); computeTotalQuestions(); }
function init(){
  const saved = tryLoadSaved();
  if(saved){ applySaved(saved,false); }
  else { startFresh(); }
  buildTabs(); render(); tick();
}
buildTabsOnce(); init();
</script>
</body>
</html>
