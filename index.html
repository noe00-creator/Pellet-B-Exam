<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PELLETB Practice Exam</title>
  <style>
    :root{--bg:#0b1020;--card:#121936;--ink:#f6f8ff;--muted:#a9b3d0;--accent:#7aa2ff;--good:#1ad598;--bad:#ff5a7a}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0a0f1e,#0f1630);} 
    .wrap{max-width:1024px;margin:0 auto;padding:24px;color:var(--ink)}
    h1{font-weight:800;letter-spacing:.3px;margin:4px 0 12px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px 18px;box-shadow:0 12px 20px rgba(0,0,0,.25)}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;gap:8px;align-items:center;background:#0d1330;border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.primary{background:var(--accent);color:#08112b}
    button.ghost{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.15)}
    button.danger{background:var(--bad);color:#08112b}
    button.good{background:var(--good);color:#04141a}
    button:disabled{opacity:.5;cursor:not-allowed}
    .section-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{background:#0e1440;border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:12px;color:var(--muted);cursor:pointer;font-weight:700}
    .tab.active{background:var(--accent);color:#070e28}
    .timer{font-variant-numeric:tabular-nums;font-weight:800}
    .q{margin:12px 0 18px}
    .q h3{margin:0 0 10px;font-size:18px}
    .opt{display:flex;gap:10px;align-items:flex-start;border:1px solid rgba(255,255,255,.12);padding:10px;border-radius:12px;margin:8px 0;background:#0c1234;cursor:pointer}
    .opt input{margin-top:2px}
    .feedback{margin-top:8px;font-weight:700}
    .feedback.good{color:var(--good)}
    .feedback.bad{color:var(--bad)}
    .controls{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px}
    .progress{height:8px;background:#0a0f28;border-radius:8px;overflow:hidden}
    .bar{height:8px;background:var(--accent);width:0}
    .muted{color:var(--muted)}
    input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1233;color:var(--ink)}
    .small{font-size:12px;color:var(--muted)}
    .banner{display:flex;gap:12px;align-items:center;justify-content:space-between;background:#09102c;border:1px dashed rgba(255,255,255,.18);padding:10px 12px;border-radius:12px;margin:10px 0}
    .summary h2{margin:4px 0 10px}
    .summary .stat{display:inline-block;background:#0e1440;border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:12px;margin-right:8px}
    .summary .miss{border:1px solid rgba(255,255,255,.15);padding:10px;border-radius:12px;margin:10px 0;background:#0b1233}
    .big-actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h1>PELLETB Practice Exam</h1>
          <div class="row">
            <span class="badge"><strong>Total Time:</strong> <span class="timer" id="totalTimer">03:00:00</span></span>
            <span class="badge"><strong>Section Time:</strong> <span class="timer" id="sectionTimer">45:00</span></span>
            <span class="badge" id="scoreBadge">Score: 0</span>
          </div>
        </div>
        <div class="big-actions">
          <button class="good" id="saveBtn">ðŸ’¾ Save & Pause</button>
          <button class="ghost" id="resumeBtn" style="display:none">â–¶ Resume</button>
          <button class="danger" id="finishBtn">âœ” Finish & Review</button>
        </div>
      </div>

      <div class="banner" id="resumeBanner" style="display:none">
        <div>Saved progress detected. You can resume where you left off, with your remaining time restored.</div>
        <div class="row">
          <button class="good" id="resumeNow">Resume now</button>
          <button class="ghost" id="startOver">Start over</button>
        </div>
      </div>

      <div class="section-tabs" id="tabs"></div>
      <div id="screen"></div>
      <div class="controls" id="navControls">
        <div style="flex:1">
          <div class="progress"><div id="progressBar" class="bar"></div></div>
          <div class="small" id="progressText">Question 0 of 0</div>
        </div>
        <div class="row">
          <button class="ghost" id="prevBtn">â—€ Prev</button>
          <button class="primary" id="nextBtn">Next â–¶</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Immediate feedback is shown <em>after</em> you answer. Use <strong>Save & Pause</strong> any time; your remaining time will be preserved for when you return.</div>
    </div>
  </div>

<script>
// ========= STORAGE & UTILS =========
const STORAGE_KEY = 'pelletb.practice.v2';
function $(id){return document.getElementById(id)}
function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)); const hh=String(Math.floor(s/3600)).padStart(2,'0'); const mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}` }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr }

// ========= QUESTION BANK (expanded) =========
// NOTE: We will randomize question order on first run, then save it so resume keeps the same order.
// You can tune timing by enabling AUTO_TIME below.
let SECTIONS = [
  {
    id:'writing', label:'Writing (Clarity & Grammar)', minutes:45,
    questions:[
      {type:'mc', prompt:'Choose the sentence that is most clear and grammatically correct.', choices:[
        'The suspect, who we seen earlier, was detained.',
        'The suspect whom we saw earlier was detained.',
        'The suspect who we seen earlier, was detained.',
        'The suspect which we saw earlier was detained.'
      ], answer:1, explain:'"whom" is correct as the object of "saw"; no comma is needed.'},
      {type:'mc', prompt:'Select the sentence with correct comma usage.', choices:[
        'Officers secured the scene and, waited for detectives.',
        'Officers secured the scene, and waited for detectives.',
        'Officers secured the scene and waited for detectives.',
        'Officers, secured the scene and waited for detectives.'
      ], answer:2, explain:'No comma is needed because the compound predicate shares the same subject.'},
      {type:'mc', prompt:'Choose the sentence free of ambiguity.', choices:[
        'The victim reported seeing a man with a hat and a backpack running.',
        'The victim reported that a man wearing a hat and backpack was running.',
        'The victim reported seeing a man running with a hat and backpack (unclear).',
        'Running, the victim reported a man with a hat and backpack.'
      ], answer:1, explain:'Option 2 specifies the man wore the hat and backpack, not the victim.'},
      {type:'mc', prompt:'Pick the best transition.', choices:[
        'The door was forced open. However the frame was undamaged.',
        'The door was forced open, however, the frame was undamaged.',
        'The door was forced open; however, the frame was undamaged.',
        'The door was forced open however the frame was undamaged.'
      ], answer:2, explain:'Use a semicolon before a conjunctive adverb and a comma after it.'},
      {type:'mc', prompt:'Select the correct subjectâ€“verb agreement.', choices:[
        'Neither the witnesses nor the suspect are credible.',
        'Neither the witnesses nor the suspect is credible.',
        'Neither the witness nor the suspects is credible.',
        'Neither the witnesses nor the suspects is credible.'
      ], answer:1, explain:'With "neither/nor," the verb agrees with the nearer subject: "suspect is".'},
      {type:'mc', prompt:'Choose the most concise option.', choices:[
        'Due to the fact that it was raining, we delayed the search.',
        'Because it was raining, we delayed the search.',
        'On account of the rain, a delay of the search was effectuated.',
        'As a result of rain, there was a delay of the search.'
      ], answer:1, explain:'"Because it was raining" is clear and concise.'},
      {type:'mc', prompt:'Identify the sentence with correct parallel structure.', choices:[
        'The suspect fled, jumping fences and to run through yards.',
        'The suspect fled, jumped fences, and runs through yards.',
        'The suspect fled, jumping fences and running through yards.',
        'The suspect flees, jumped fences, and running through yards.'
      ], answer:2, explain:'Gerunds should match: jumpingâ€¦running.'},
      {type:'mc', prompt:'Which sentence is correctly punctuated?', choices:[
        'Each officer was issued a Taser; body camera and radio.',
        'Each officer was issued a Taser, body camera, and radio.',
        'Each officer, was issued a Taser body camera, and radio.',
        'Each officer was issued; a Taser, body camera, and radio.'
      ], answer:1, explain:'Use commas for simple lists.'},
      {type:'mc', prompt:'Choose the sentence with correct pronoun case.', choices:[
        'It was them who arrived first at the scene.',
        'It was they who arrived first at the scene.',
        'It was him who arrived first at the scene.',
        'It was her that arrived first at the scene.'
      ], answer:1, explain:'Formal standard: "It was they whoâ€¦" uses the subject case after a linking verb.'},
      {type:'mc', prompt:'Choose the best revision for clarity.', choices:[
        'Having finished the interview, the report was written by Officer Diaz.',
        'The report was written after finishing the interview by Officer Diaz.',
        'After Officer Diaz finished the interview, she wrote the report.',
        'After finishing, the report was written.'
      ], answer:2, explain:'Avoid dangling modifiers; Option 3 makes the actor clear.'}
    ]
  },
  {
    id:'spelling', label:'Spelling (Law & Report Words)', minutes:45,
    questions:[
      // This section intentionally uses INPUT (not multiple choice) to train exact spelling.
      {type:'spelling', prompt:'Type the correct spelling: The judge issued a ____ to appear in court.', answer:'subpoena', explain:'Correct spelling: subpoena.'},
      {type:'spelling', prompt:'Type the correct spelling: The suspect was found in ____ of narcotics.', answer:'possession', explain:'Double s: poss-ess-ion.'},
      {type:'spelling', prompt:'Type the correct spelling: We began fixed-camera ____ at the location.', answer:'surveillance', explain:'Double â€œlâ€ + â€œeillanceâ€.'},
      {type:'spelling', prompt:'Type the correct spelling: The incident ____ at 1930 hours.', answer:'occurred', explain:'Past tense with double "r".'},
      {type:'spelling', prompt:'Type the correct spelling: The officer did not ____ the vehicle.', answer:'pursue', explain:'Not "persue".'},
      {type:'spelling', prompt:'Type the correct spelling: The property was kept in the evidence _____.', answer:'warehouse', explain:'Compound word.'},
      {type:'spelling', prompt:'Type the correct spelling: The team executed a search ____ issued by a judge.', answer:'warrant', explain:'Two râ€™s.'},
      {type:'spelling', prompt:'Type the correct spelling: The report was kept ____ from opinion.', answer:'separate', explain:'Not "seperate".'},
      {type:'spelling', prompt:'Type the correct spelling: The defendant was found not guilty and received an ____. ', answer:'acquittal', explain:'Two câ€™s, two tâ€™s.'},
      {type:'spelling', prompt:'Type the correct spelling: Officers read the ____ rights.', answer:'Miranda', explain:'Capitalized surname.'},
      {type:'spelling', prompt:'Type the correct spelling: Evidence of drug ________ was photographed.', answer:'paraphernalia', explain:'para-pher-na-lia.'},
      {type:'spelling', prompt:'Type the correct spelling: The court entered a default ________ against the defendant.', answer:'judgment', explain:'U.S. legal spelling: â€œjudgmentâ€.'},
      {type:'spelling', prompt:'Type the correct spelling: The cash was subject to civil ________.', answer:'forfeiture', explain:'for-fei-ture.'},
      {type:'spelling', prompt:'Type the correct spelling: The school requested a parent-_______ to discuss attendance.', answer:'liaison', explain:'liai-son.'},
      {type:'spelling', prompt:'Type the correct spelling: The property was ______ and logged.', answer:'seized', explain:'Verb â€œseizeâ€ â†’ â€œseizedâ€.'},
      {type:'spelling', prompt:'Type the correct spelling: The offense is a ________ (less than a felony).', answer:'misdemeanor', explain:'mis-de-mean-or.'},
      {type:'spelling', prompt:'Type the correct spelling: The officer noted the suspect showed ________ (not â€œresistenceâ€).', answer:'resistance', explain:'resis-tance.'},
      {type:'spelling', prompt:'Type the correct spelling: It was a repeat ________ of the policy.', answer:'violation', explain:'vio-la-tion.'},
      {type:'spelling', prompt:'Type the correct spelling: The teen is a ________ under state law.', answer:'juvenile', explain:'ju-ve-nile.'},
      {type:'spelling', prompt:'Type the correct spelling: The driverâ€™s ________ is suspended.', answer:'license', explain:'American spelling.'}
    ]
  },
  {
    id:'reading', label:'Reading Comprehension', minutes:45,
    questions:[
      {type:'mc', prompt:'Passage: Officers responded to a call at 2215 hours regarding a disturbance at 840 Pine St. Upon arrival, they observed a broken window and found a wallet on the sidewalk bearing the name â€œJ. Ramos.â€ Neighbors reported seeing a blue sedan depart eastbound at high speed two minutes prior. Question: Which detail MOST strongly suggests a forced entry?', choices:[
        'The time of the call.', 'The broken window.', 'The wallet on the sidewalk.', 'The sedan traveling eastbound.'
      ], answer:1, explain:'A broken window indicates the structure may have been breached.'},
      {type:'mc', prompt:'Passage: The departmentâ€™s new policy requires officers to log each use of a control hold in the field training app within 24 hours. Supervisors will review entries weekly. Question: What is the primary purpose of the weekly review?', choices:[
        'To discipline officers who use control holds.', 'To ensure timely maintenance of the app.', 'To provide oversight and identify training needs.', 'To eliminate the use of control holds.'
      ], answer:2, explain:'Reviews provide oversight and can reveal training gaps.'},
      {type:'mc', prompt:'Passage: During a burglary investigation, shoe prints were found leading from the rear door to the alley, where a bicycle lock was discovered. Question: Which inference is MOST reasonable?', choices:[
        'The suspect definitely escaped on a bicycle.', 'The suspect may have used or intended to use a bicycle.', 'The shoe prints were left by a neighbor.', 'The lock belongs to the victim.'
      ], answer:1, explain:'Evidence suggests a bicycle connection but does not prove it.'},
      {type:'mc', prompt:'Passage: A school resource officer held a safety talk. Afterward, the number of students reporting bullying increased. What is the BEST explanation?', choices:[
        'Bullying incidents increased after the talk.', 'Students became more willing to report incidents.', 'The talk encouraged false reports.', 'The officer failed to communicate clearly.'
      ], answer:1, explain:'Awareness often increases reporting rather than incidents.'},
      {type:'mc', prompt:'Passage: A city park closes at 2200 hours. A runner is contacted at 2215 hours near a locked gate and claims ignorance of the rule. What is the MOST appropriate immediate action based on policy that emphasizes education before citation?', choices:[
        'Cite the runner immediately.', 'Detain the runner for trespass investigation.', 'Provide a warning and explain the posted hours.', 'Arrest the runner for resisting.'
      ], answer:2, explain:'Education-first policy â†’ warning with explanation (unless aggravating factors).'},
      {type:'mc', prompt:'Passage: Dispatch notes repeated noise complaints at the same apartment over two months. Tonight, the resident is cooperative and lowers the volume. What is the BEST documentation for long-term problem solving?', choices:[
        'No report since the issue stopped.', 'Brief log entry referencing prior calls.', 'Full crime report for disturbing the peace.', 'Email to the city attorney.'
      ], answer:1, explain:'A brief log entry connects the history and supports future action.'},
      {type:'mc', prompt:'Passage: A campus officer notes an increase in bicycle thefts near one rack after sunset. Lighting is dim and surveillance coverage is partial. Which action BEST addresses the underlying cause?', choices:[
        'Increase citations for loitering.', 'Recommend improved lighting and camera coverage.', 'Close the rack permanently.', 'Conduct random backpack searches.'
      ], answer:1, explain:'Environmental changes (lighting/cameras) target the cause.'},
      {type:'mc', prompt:'Passage: A witness states, â€œThe driver was tall, maybe six feet, wearing a red hoodie, and drove off in a white hatchback.â€ What is the MOST reliable detail for BOLO?', choices:[
        'Height ~6 feet', 'Red hoodie', 'White hatchback', 'Driver was tall and nervous'
      ], answer:2, explain:'Vehicle make/style and color are often more consistently observed than height.'},
      {type:'mc', prompt:'Passage: Policy requires secondary searches of arrestees before transport. During review, a supervisor finds several cases with no secondary search noted. What is the primary concern?', choices:[
        'Officer safety is at risk.', 'Report length is excessive.', 'The transport log is outdated.', 'Property rooms are overloaded.'
      ], answer:0, explain:'Missing secondary searches create safety risks.'},
      {type:'mc', prompt:'Passage: A teacher emails that a student made a vague threat to "get even" after a grade dispute. The student has no prior history. What is the BEST initial step?', choices:[
        'Immediate arrest for threats.', 'Document and conduct a threat assessment with administration.', 'Ignore unless a weapon is seen.', 'Notify media to deter copycats.'
      ], answer:1, explain:'Use structured threat assessment with documentation.'}
    ]
  },
  {
    id:'reasoning', label:'Reasoning Ability', minutes:45,
    questions:[
      {type:'mc', prompt:'All trespassers in the park after 10 p.m. receive citations. Carlos is in the park at 11 p.m. What MUST be true?', choices:[
        'Carlos will be arrested.', 'Carlos will receive a citation.', 'Carlos is a minor.', 'Carlos has committed burglary.'
      ], answer:1, explain:'Given the rule, he must be cited; arrest is not implied.'},
      {type:'mc', prompt:'Evidence lockers A, B, and C must be checked in that order. If B is unavailable, C cannot be checked. Today, A was checked; C was not checked. What can be inferred?', choices:[
        'B was available and checked.', 'B was unavailable.', 'A was unavailable.', 'C was checked before A.'
      ], answer:1, explain:'Since C was not checked, B must have been unavailable.'},
      {type:'mc', prompt:'If no vehicles are allowed in Lane 2 and all delivery trucks are vehicles, which is true?', choices:[
        'Some delivery trucks may use Lane 2.', 'No delivery trucks may use Lane 2.', 'Only emergency vehicles may use Lane 2.', 'Lane 2 is closed.'
      ], answer:1, explain:'Delivery trucks are vehicles, so they cannot use Lane 2.'},
      {type:'mc', prompt:'The keys are in the locker, the desk, or the patrol car. They are not in the locker. If they are in the patrol car, Officer Lee would have found them, but she did not. Where are the keys?', choices:[
        'Locker', 'Desk', 'Patrol car', 'Unknown'
      ], answer:1, explain:'Eliminate locker; eliminate patrol car based on Lee; remaining: desk.'},
      {type:'mc', prompt:'Exactly one of the three statements is true: (1) The suspect wore a hat. (2) The suspect wore glasses. (3) The suspect wore neither. Which is true?', choices:[
        '(1)', '(2)', '(3)', 'None'
      ], answer:0, explain:'Test each caseâ€”only (1) can be true without contradiction.'},
      {type:'mc', prompt:'A logbook requires entries every 30 minutes starting at 0800. An entry exists at 0830 and 0900, but none at 0930. What is the earliest time a supervisor can say the policy was first violated?', choices:[
        '0830', '0900', '0930', '1000'
      ], answer:2, explain:'The missing 0930 entry is the first violation.'},
      {type:'mc', prompt:'Three suspectsâ€”A, B, and Câ€”cannot be interviewed at the same time. If A is interviewed before B, and C must be last, which order is valid?', choices:[
        'A, C, B', 'B, A, C', 'A, B, C', 'C, A, B'
      ], answer:2, explain:'A before B, C last â†’ A, B, C.'},
      {type:'mc', prompt:'At a checkpoint, every third car is inspected. The 9th car is inspected. Which of the following is also inspected?', choices:[
        '12th', '13th', '14th', '15th'
      ], answer:0, explain:'Multiples of 3 â†’ 12th, 15th, etc.'},
      {type:'mc', prompt:'All entry badges are numbered. Badges divisible by 3 also have a blue stripe. Badge #27 is missing a stripe. Which MUST be true?', choices:[
        'Badge #27 is fake.', 'Badge #27 is not divisible by 3.', 'The stripe may have worn off.', 'Badge #27 was misprinted.'
      ], answer:1, explain:'#27 without a stripe means it cannot be divisible by 3 under the rule.'}
    ]
  }
];

// ========= STATE =========
const state = {sectionIndex:0, qIndex:0, answers:{}, correct:0, total:0, sectionEnds:[], totalEnds:0, running:true};

// ========= INITIALIZATION & AUTO-TIME =========
// Auto-time: scale section minutes based on number of questions so the test length matches content.
// Toggle here:
const AUTO_TIME = true;                   // set to false to use fixed minutes per section
const MIN_PER_MC = 2;                     // minutes per multiple-choice question
const MIN_PER_SPELL = 1.5;                // minutes per spelling item
const MIN_PER_READING = 2.5;              // minutes per reading item
const MIN_PER_REASON = 2;                 // minutes per reasoning item
const CAP_TOTAL_MINUTES = 180;            // cap total runtime (e.g., 3 hours)

function minutesForSection(sec){
  if(!AUTO_TIME) return sec.minutes;
  let m=0;
  sec.questions.forEach(q=>{
    if(q.type==='mc') m+= MIN_PER_MC; 
    else if(q.type==='spelling') m+= MIN_PER_SPELL;
    else m+=2; // default
  });
  return Math.max(10, Math.round(m));
}

function applyAutoTimeCap(){
  if(!AUTO_TIME) return;
  const mins=SECTIONS.map(minutesForSection);
  let total=mins.reduce((a,b)=>a+b,0);
  if(total>CAP_TOTAL_MINUTES){
    const factor = CAP_TOTAL_MINUTES/total;
    SECTIONS = SECTIONS.map((s,i)=>({ ...s, minutes: Math.max(10, Math.round(mins[i]*factor)) }));
  } else {
    SECTIONS = SECTIONS.map((s,i)=>({ ...s, minutes: mins[i] }));
  }
}

function init(){
  const saved = tryLoadSaved();
  if(saved){
    applySaved(saved, false);
  } else {
    prepareSectionsFromScratch();
    applyAutoTimeCap();
    computeTimers(null);
    state.total = SECTIONS.reduce((a,s)=>a+s.questions.length,0);
  }
  buildTabs();
  render();
  tick();
}

// ========= UI RENDER =========
function buildTabs(){
  const tabs = $('tabs'); tabs.innerHTML='';
  SECTIONS.forEach((sec,i)=>{
    const b=document.createElement('button');
    b.className='tab'+(i===state.sectionIndex?' active':'');
    b.textContent=`${i+1}. ${sec.label}`;
    b.onclick=()=>{ state.sectionIndex=i; state.qIndex=0; renderTabs(); render(); };
    tabs.appendChild(b);
  });
}
function renderTabs(){
  [...document.querySelectorAll('.tab')].forEach((el,idx)=>{ el.classList.toggle('active', idx===state.sectionIndex); });
}

function render(){
  const sec=SECTIONS[state.sectionIndex];
  const q=sec.questions[state.qIndex];
  const sKey=`${sec.id}:${state.qIndex}`;
  const ans=state.answers[sKey];

  const answered = Object.keys(state.answers).length;
  $('scoreBadge').textContent=`Score: ${state.correct}`;
  $('progressText').textContent=`Question ${state.qIndex+1} of ${sec.questions.length} (Section ${state.sectionIndex+1}/${SECTIONS.length}) â€¢ Answered: ${answered}/${state.total}`;
  $('progressBar').style.width = `${(state.qIndex+1)/sec.questions.length*100}%`;

  const screen=$('screen'); screen.innerHTML='';
  const qWrap=document.createElement('div'); qWrap.className='q';
  const h=document.createElement('h3'); h.textContent=q.prompt; qWrap.appendChild(h);

  if(q.type==='mc'){
    q.choices.forEach((c,i)=>{
      const row=document.createElement('label'); row.className='opt';
      const radio=document.createElement('input'); radio.type='radio'; radio.name='mc'; radio.value=i; radio.checked = ans?.choice===i;
      radio.onchange=()=>gradeMC(i);
      const span=document.createElement('div'); span.textContent=c;
      row.appendChild(radio); row.appendChild(span);
      qWrap.appendChild(row);
      if(ans){
        if(i===q.answer){ row.style.borderColor='rgba(26,213,152,.9)'; }
        if(ans.choice===i && i!==q.answer){ row.style.borderColor='rgba(255,90,122,.9)'; }
      }
    });
  }
  if(q.type==='spelling'){
    const input=document.createElement('input'); input.type='text'; input.placeholder='Type the correct spellingâ€¦'; input.value = ans?.text||'';
    const check=document.createElement('button'); check.className='primary'; check.textContent='Check';
    const fb=document.createElement('div'); fb.className='feedback';
    check.onclick=()=>gradeSpelling(input.value);
    qWrap.appendChild(input); qWrap.appendChild(document.createElement('div')).style.height='8px'; qWrap.appendChild(check); qWrap.appendChild(fb);
    if(ans){ fb.textContent = ans.correct? 'Correct âœ”' : `Incorrect âœ– â€” Correct: ${q.answer}`; fb.className = 'feedback ' + (ans.correct? 'good':'bad'); }
  }

  const exp=document.createElement('div'); exp.className='muted'; exp.style.marginTop='8px'; if(ans){ exp.innerHTML = `<strong>Why:</strong> ${q.explain||'â€”'}`; }
  qWrap.appendChild(exp);
  screen.appendChild(qWrap);

  $('prevBtn').disabled = state.qIndex===0; $('nextBtn').disabled = state.qIndex===sec.questions.length-1;
}

// ========= GRADING =========
function gradeMC(choice){
  const sec=SECTIONS[state.sectionIndex];
  const q=sec.questions[state.qIndex];
  const key=`${sec.id}:${state.qIndex}`; const already = state.answers[key]?.graded; const correct = choice===q.answer;
  state.answers[key] = {graded:true, choice, correct}; if(!already && correct){ state.correct++; }
  render();
}
function gradeSpelling(text){
  const sec=SECTIONS[state.sectionIndex]; const q=sec.questions[state.qIndex];
  const key=`${sec.id}:${state.qIndex}`; const already = state.answers[key]?.graded;
  const correct = (text||'').trim().toLowerCase() === q.answer.toLowerCase();
  state.answers[key] = {graded:true, text, correct}; if(!already && correct){ state.correct++; }
  render();
}

// ========= NAV + TIMERS =========
$('prevBtn').onclick=()=>{ if(state.qIndex>0){ state.qIndex--; render(); } };
$('nextBtn').onclick=()=>{ const sec=SECTIONS[state.sectionIndex]; if(state.qIndex<sec.questions.length-1){ state.qIndex++; render(); } };
$('finishBtn').onclick=()=> showSummary();
$('saveBtn').onclick=()=> saveProgress(true);
$('resumeBtn').onclick=()=> resumeNow();
$('resumeNow').onclick=()=> resumeNow();
$('startOver').onclick=()=> resetAll();

function resumeNow(){ const saved = tryLoadSaved(); if(saved){ applySaved(saved, true); render(); tick(); }}

function tick(){
  if(!state.running) return;
  const now=Date.now(); const totalLeft = state.totalEnds - now; $('totalTimer').textContent = fmt(totalLeft);
  const secEnd = state.sectionEnds[state.sectionIndex]; $('sectionTimer').textContent = fmt(secEnd - now);
  if(totalLeft<=0){ state.running=false; showSummary(true); return; }
  requestAnimationFrame(tick);
}

// ========= SUMMARY =========
function showSummary(timeUp=false){
  state.running=false;
  const screen=$('screen'); screen.innerHTML=''; $('navControls').style.display='none';
  const wrapper=document.createElement('div'); wrapper.className='summary';
  const totalQ = SECTIONS.reduce((a,s)=>a+s.questions.length,0); const correct = Object.values(state.answers).filter(a=>a.correct).length;
  const percent = Math.round((correct/totalQ)*100);
  const h2=document.createElement('h2'); h2.textContent = timeUp? 'Time! Results & Review':'Results & Review'; wrapper.appendChild(h2);
  const stats=document.createElement('div');
  stats.innerHTML = `<span class="stat">Score: <strong>${correct}/${totalQ}</strong> (${percent}%)</span>` +
    SECTIONS.map((sec,i)=>{ const keys = Object.keys(state.answers).filter(k=>k.startsWith(sec.id+':')); const c = keys.filter(k=>state.answers[k].correct).length; return `<span class="stat">${i+1}. ${sec.label}: <strong>${c}/${sec.questions.length}</strong></span>`; }).join(' ');
  wrapper.appendChild(stats);

  const misses=[];
  SECTIONS.forEach((sec)=>{
    sec.questions.forEach((q,idx)=>{
      const k=`${sec.id}:${idx}`; const a=state.answers[k]; if(!a || !a.correct){ misses.push({sec, q, idx, a}); }
    })
  });
  if(misses.length){
    const t=document.createElement('h3'); t.textContent='Missed or Unanswered Questions'; wrapper.appendChild(t);
    misses.forEach(m=>{
      const div=document.createElement('div'); div.className='miss';
      const chosen = m.a?.choice!=null ? m.q.choices?.[m.a.choice] : (m.a?.text||'(no answer)');
      let correctText = m.q.type==='mc' ? m.q.choices[m.q.answer] : m.q.answer;
      div.innerHTML = `<strong>Section:</strong> ${m.sec.label}<br><strong>Question:</strong> ${m.q.prompt}<br><strong>Your answer:</strong> ${chosen}<br><strong>Correct:</strong> ${correctText}${m.q.explain? `<br><em>Why:</em> ${m.q.explain}`:''}`;
      wrapper.appendChild(div);
    });
  }

  const actions=document.createElement('div'); actions.className='row';
  const restart=document.createElement('button'); restart.className='ghost'; restart.textContent='Start a New Attempt'; restart.onclick=()=>{ resetAll(); };
  const saveRep=document.createElement('button'); saveRep.className='primary'; saveRep.textContent='Save Results'; saveRep.onclick=()=>{ saveProgress(true); };
  actions.appendChild(restart); actions.appendChild(saveRep); wrapper.appendChild(actions);
  screen.appendChild(wrapper);
}

// ========= BOOT =========
window.addEventListener('beforeunload', ()=>{ if(state.running){ saveProgress(true); } });

init();
</script>
</body>
</html>
